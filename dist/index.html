<div><script type="@plotdb/block">var mod;module.exports={pkg:{name:"pie",version:"0.0.1",extend:{name:"@makechart/base"},dependencies:[],i18n:{"zh-TW":{value:"數值",name:"名稱",category:"分類",other:"其它"}}},init:function(t){var e,r,n,i;e=t.root,r=t.context,n=t.pubsub,i=t.t;return n.fire("init",{mod:mod({context:r,t:i})})}};mod=function(t){var e,r,n,g,i;e=t.context,r=t.t;n=e.chart,g=e.d3;return{sample:function(){return{raw:[1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30].map(function(t){return{val:(10*Math.random()).toFixed(2),c1:"A"+Math.ceil(Math.random()*7),c2:"B"+Math.ceil(Math.random()*4),c3:"C"+Math.ceil(Math.random()*4),name:"N:"+t}}),binding:{name:{key:"name"},category:[{key:"c1"},{key:"c2"},{key:"c3"}],value:{key:"val"}}}},config:(i=n.utils.config.from({tip:"tip",preset:"default",legend:"legend"}),i.donut={percent:{type:"number",default:.7,min:0,max:1,step:.01},padding:{type:"number",default:.03,min:0,max:1,step:.01}},i),dimension:{name:{type:"NCO",name:"name",priority:10},value:{type:"R",name:"value",priority:20},category:{type:"C",name:"category",priority:25,multiple:true}},init:function(){var e,a=this;this.g=Object.fromEntries(["view","legend"].map(function(t){return[t,g.select(a.layout.getGroup(t)).append("g")]}));this.tint=e=new n.utils.tint;this.tip=new n.utils.tip({root:this.root,accessor:function(t){var e,r,n,i;e=t.evt;if(!(e.target&&(r=g.select(e.target).datum()))){return null}n=isNaN(r.value)?"-":g.format(a.cfg.tip.format||".2s")(r.value)+""+(a.binding.value.unit||"");return{name:r.name||(r.category?(i=r.category)[i.length-1]:"-"),value:n}},range:function(){return a.layout.getNode("view").getBoundingClientRect()}});this.legend=new n.utils.legend({layout:this.layout,name:"legend",root:this.root,shape:function(t){return g.select(this).attr("fill",e.get(t.text))},cfg:{selectable:true}});this.legend.on("select",function(){a.parse();a.bind();a.resize();return a.render()});this.arc=g.arc().startAngle(0).endAngle(Math.PI/2);this.total={};return this.hover={}},destroy:function(){return this.tip.destroy()},parse:function(){var t,i,h,e,r,n,f,a,o,u,l,c;this.tint.reset();t=this.binding.category||[];i=this.all;this.all=h=[];e=this.data.map(function(t){var e;return e=import$({},t),e.value=isNaN(+t.value)||!t.value?0:+t.value,e});for(r=0,n=t.length;r<n;++r){f=r;a={};e.map(s);h.push(d())}h.push(e.map(function(t){return import$({colorKey:t.category[0]||t.name},t)}));for(r=0,n=h.length;r<n;++r){f=r;l=h[f];l.sort(g)}h.map(function(t,r){return t.map(function(t,e){t._idx=e;return t._lv=r})});if(i){h.map(function(t,n){return t.map(function(t,e){var r;if(i[n]&&i[n][e]){return t.old=(r=i[n][e]).old,t.cur=r.cur,t}})})}c=this.all[0].map(function(t){return{text:t.colorKey,key:t.colorKey,value:t.value}});return this.legend.data(c);function s(t){var e,r;e=t.category.slice(0,f+1);r=e.map(function(t){return((t||"")+"").replace(/\//g,"//")}).join("/");if(!a[r]){a[r]={category:e,colorKey:e[0]||t.name,value:0}}return a[r].value+=t.value}function d(){var t,e=[];for(o in t=a){u=t[o];e.push(u)}return e}function g(i,a){var t,e,o,r,n,u,l;for(t=0,e=f;t<e;++t){o=t;r=h[o].filter(c);n=h[o].filter(s);u=r.map(d).indexOf(i.category[o]);l=n.map(g).indexOf(a.category[o]);if(u===l){continue}return u-l}return a.value-i.value;function c(t){var e,r,n;for(e=0,r=o;e<r;++e){n=e;if(t.category[n]!==i.category[n]){return false}}return true}function s(t){var e,r,n;for(e=0,r=o;e<r;++e){n=e;if(t.category[n]!==a.category[n]){return false}}return true}function d(t){return t.category[o]}function g(t){return t.category[o]}}},bind:function(){var e=this;return this.all.map(function(t){return t.map(function(t){return t.picked=e.legend.isSelected(t.colorKey)})})},resize:function(){var t,e,r,n,i,a;this.tip.toggle(((t=this.cfg).tip||(t.tip={})).enabled!=null?this.cfg.tip.enabled:true);this.root.querySelector(".pdl-layout").classList.toggle("legend-bottom",this.cfg.legend.position==="bottom");this.legend.config(import$({},this.cfg.legend));this.legend.update();this.layout.update(false);e=this.root.getBoundingClientRect();r=this.layout.getBox("legend");if(this.cfg.legend.position==="bottom"){t=[e.width,e.height-r.height],n=t[0],i=t[1]}else{t=[e.width-r.width,e.height],n=t[0],i=t[1]}a=n>i?i:n;t=this.layout.getNode("view").style;t.width=a+"px";t.height=a+"px";return this.layout.update(false)},render:function(){var t,i,o,a,m,v,u,l,e,r,n,c,y,s,d,x=this;t=this.binding,i=this.legend,o=this.arc,a=this.tint,m=this.all,v=this.cfg,u=this.hover;l=function(){return x.render()};e=this.layout.getBox("view");r=[e.width,e.height],n=r[0],c=r[1];y=Math.min(n,c);this.total.old=this.total.cur;this.total.cur=this.all[0].reduce(function(t,e){return t+(e.picked?e.value:0)},0)||1;if(!this.total.old){this.total.old=this.total.cur}m.map(function(t,e){var r,n,i,a,o,u,l,c,s,d,g,h,f,p=[];r=0;n=v.donut.percent*y/2;i=y/2;a=v.donut.padding*(i-n)/(m.length-1||1);o=(i-n)*(1-v.donut.padding)/(m.length||1);u=n+(o+a)*e;l=n+(o+a)*e+o;a=.002*a;for(c=0,s=t.length;c<s;++c){d=c;g=t[d];if(!g.old){g.old={s:(h=t[d-1])?h.old.e:0,e:0,r1:u,r2:u,rp:a}}if(g.cur){g.old=g.cur}f=g.value||0;g.cur={s:r,e:r+(g.picked?f:0),r1:u,r2:l,rp:a};g.old.angle={s:2*Math.PI*g.old.s/x.total.old,e:2*Math.PI*g.old.e/x.total.old};g.cur.angle={s:2*Math.PI*g.cur.s/x.total.cur,e:2*Math.PI*g.cur.e/x.total.cur};if(g.picked){p.push(r+=f)}}return p});s=function(i,a,t){return function(e){var t,r,n;o.innerRadius((a.r1-i.r1)*e+i.r1).outerRadius((a.r2-i.r2)*e+i.r2).padAngle((a.rp-i.rp)*e+i.rp);t=["s","e"].map(function(t){return(a.angle[t]-i.angle[t])*e+i.angle[t]}),r=t[0],n=t[1];x.arc.startAngle(r).endAngle(n);return x.arc()}};if(this.cfg!=null&&this.cfg.palette){this.tint.set(this.cfg.palette.colors.map(function(t){return t.value||t}))}e=this.layout.getBox("view");this.g.view.attr("transform","translate("+e.width/2+","+e.height/2+")");d=this.g.view.selectAll("g.ring").data(this.all);d.exit().remove();d.enter().append("g").attr("class","ring");return this.g.view.selectAll("g.ring").each(function(t,r){var e,n;e=g.select(this);n=e.selectAll("path.data").data(t,function(t){return t.name||t._idx});n.exit().remove();n.enter().append("path").attr("class","data").on("mouseover",function(t,e,r){u.item=e;return l()}).on("mouseout",function(t,e,r){u.item=null;return l()}).attr("opacity",function(t,e){return 0}).attr("fill",function(t,e){return a.get(t.colorKey||t._idx)});e.selectAll("path.data").transition().duration(350).attrTween("d",function(t,e){return s(t.old,t.cur,r)}).attr("fill",function(t,e){return a.get(t.colorKey||t._idx)}).attr("opacity",function(t,e){var r,n,i,a;if(!(r=u.item)){return 1}if(r.category){for(n=0,i=r.category.length;n<i;++n){a=n;if(t.category[a]!==r.category[a]){return.3}if(a===t.category.length-1){break}}if(t._lv===r._lv&&t!==r){return.3}return 1}else if(u.item.name===t.name){return 1}else{return.3}});return i.render()})}}};function import$(t,e){var r={}.hasOwnProperty;for(var n in e)if(r.call(e,n))t[n]=e[n];return t}</script><div plug="layout"><div class="pdl-layout"><div data-type="layout"><div class="pdl-cell" data-name="view"></div><div class="pdl-cell" data-name="legend"></div></div><div data-type="render"></div></div></div><style type="text/css">.pdl-layout>div[data-type=layout]{display:flex;justify-content:center;align-items:center;gap:1em}.pdl-layout>div[data-type=layout] .pdl-cell[data-name=legend]{height:100%}.pdl-layout.legend-bottom>div[data-type=layout]{flex-direction:column}.pdl-layout.legend-bottom>div[data-type=layout] .pdl-cell[data-name=legend]{height:auto}</style></div>